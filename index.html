<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Rain: Sky Guardian</title>
    <style>
        :root {
            --primary: #00d2ff;
            --secondary: #3a7bd5;
            --accent: #ffd700;
            --danger: #ff4b2b;
            --dark: #1a1a2e;
            --glass: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; user-select: none; }
        
        body { 
            background: var(--dark); 
            color: white; 
            overflow: hidden; 
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        canvas {
            display: block;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
        }

        /* UI Overlays */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            transition: opacity 0.3s;
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        .menu-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .stat-label { font-size: 0.9rem; color: #aaa; margin-top: 10px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--accent); }

        button {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1.1rem;
            width: 100%;
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.95); }
        button.secondary { background: #444; }

        /* HUD */
        #hud {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 50;
        }

        .hud-item { background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .health-container { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 200px; height: 10px; background: #333; border-radius: 5px; border: 1px solid #555; }
        #health-bar { width: 100%; height: 100%; background: #00ff00; border-radius: 5px; transition: width 0.3s, background 0.3s; }

        /* Shop */
        #shop-overlay { overflow-y: auto; padding: 20px 0; }
        .shop-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 20px; 
            width: 100%;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }
        .shop-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .shop-item img { width: 30px; height: 30px; margin-bottom: 5px; align-self: center; }
        .shop-item.owned { border-color: var(--accent); opacity: 0.8; }
        .price-tag { color: var(--accent); font-weight: bold; margin: 5px 0; }

        #combo-text {
            position: absolute;
            font-size: 2rem;
            color: var(--accent);
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
        <div class="hud-item">Score: <span id="score-val">0</span></div>
        <div class="hud-item">RC: <span id="rc-val">0</span></div>
    </div>
    <div class="health-container"><div id="health-bar"></div></div>

    <div id="menu-screen" class="overlay">
        <div class="menu-card">
            <h1>R-RAIN</h1>
            <p>Sky Guardian</p>
            <div class="stat-label">BEST SCORE</div>
            <div id="best-score" class="stat-value">0</div>
            <button id="start-btn">PROTECT CITY</button>
            <button id="shop-btn" class="secondary">UPGRADES & SHOP</button>
        </div>
    </div>

    <div id="shop-screen" class="overlay hidden">
        <div class="menu-card" style="max-width: 500px;">
            <h2>CITY SHOP</h2>
            <div class="stat-label">AVAILABLE RC</div>
            <div id="shop-rc" class="stat-value">0</div>
            <div class="shop-grid" id="shop-items-container">
                </div>
            <button id="close-shop-btn">BACK TO MENU</button>
        </div>
    </div>

    <div id="gameover-screen" class="overlay hidden">
        <div class="menu-card">
            <h1 style="color: var(--danger);">CITY FALLEN</h1>
            <div class="stat-label">FINAL SCORE</div>
            <div id="final-score" class="stat-value">0</div>
            <div class="stat-label">RC EARNED</div>
            <div id="earned-rc" class="stat-value" style="color: #fff;">0</div>
            <button id="retry-btn">RETRY</button>
            <button id="shop-btn-go" class="secondary">VISIT SHOP</button>
        </div>
    </div>
</div>

<script>
/** * R-RAIN: SKY GUARDIAN
 * A Pure JavaScript High-Performance Web Game
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score-val');
const rcEl = document.getElementById('rc-val');
const healthBar = document.getElementById('health-bar');

// --- GAME STATE ---
let state = {
    running: false,
    score: 0,
    rc: parseInt(localStorage.getItem('rrain_rc')) || 0,
    bestScore: parseInt(localStorage.getItem('rrain_best')) || 0,
    health: 100,
    maxHealth: 100,
    difficulty: 1,
    combo: 0,
    drops: [],
    particles: [],
    powerups: {
        shield: 0,
        slowmo: 0,
        magnet: 0,
        multiplier: 1
    },
    ownedItems: JSON.parse(localStorage.getItem('rrain_items')) || ['default_city'],
    equippedCity: 'default',
    width: 0,
    height: 0
};

// --- CONFIG & CONSTANTS ---
const DROP_TYPES = {
    CLEAN: { color: '#00d2ff', size: 6, speed: 3, value: 10, rc: 1, type: 'good' },
    GOLD: { color: '#ffd700', size: 8, speed: 4, value: 50, rc: 5, type: 'good' },
    ENERGY: { color: '#00ff88', size: 7, speed: 3.5, value: 20, rc: 2, type: 'good', power: 'magnet' },
    HEAL: { color: '#ff4b91', size: 7, speed: 2, value: 5, rc: 0, type: 'good', power: 'heal' },
    ACID: { color: '#ccff00', size: 7, speed: 3.2, damage: 15, type: 'bad' },
    TOXIC: { color: '#9d00ff', size: 9, speed: 2.5, damage: 30, type: 'bad' },
    ICE: { color: '#ffffff', size: 6, speed: 5, damage: 5, type: 'bad', power: 'freeze' },
    LIGHTNING: { color: '#ffff00', size: 4, speed: 8, damage: 20, type: 'bad' }
};

const SHOP_ITEMS = [
    { id: 'shield_up', name: 'Nano Shield', price: 100, desc: 'Start with 5s Shield', cat: 'temp' },
    { id: 'slow_mo', name: 'Time Warp', price: 150, desc: 'Slow motion active', cat: 'temp' },
    { id: 'magnet_up', name: 'RC Magnet', price: 200, desc: 'Attracts good drops', cat: 'temp' },
    { id: 'double_rc', name: 'Wealth Core', price: 500, desc: 'Permanently 2x RC', cat: 'city' },
    { id: 'city_hp_1', name: 'Reinforced Walls', price: 300, desc: '+50 Max Health', cat: 'city' },
    { id: 'neon_city', name: 'Neon City Skin', price: 1000, desc: 'Cyberpunk Visuals', cat: 'skin' },
    { id: 'space_theme', name: 'Deep Space', price: 1500, desc: 'Galactic Background', cat: 'skin' }
];

// --- SFX (Synthesized via Web Audio) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, duration) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

// --- INITIALIZATION ---
function resize() {
    state.width = canvas.width = window.innerWidth;
    state.height = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

let player = {
    x: state.width / 2,
    y: state.height - 120,
    w: 80,
    h: 20,
    targetX: state.width / 2
};

// --- INPUT ---
canvas.addEventListener('touchmove', (e) => {
    player.targetX = e.touches[0].clientX;
});
canvas.addEventListener('mousemove', (e) => {
    player.targetX = e.clientX;
});

// --- CORE LOGIC ---
function createDrop() {
    if (!state.running) return;
    const types = Object.keys(DROP_TYPES);
    const rand = Math.random();
    let typeKey = 'CLEAN';
    
    if (rand > 0.95) typeKey = 'TOXIC';
    else if (rand > 0.85) typeKey = 'ACID';
    else if (rand > 0.80) typeKey = 'LIGHTNING';
    else if (rand > 0.75) typeKey = 'ICE';
    else if (rand > 0.70) typeKey = 'GOLD';
    else if (rand > 0.65) typeKey = 'ENERGY';
    else if (rand > 0.60) typeKey = 'HEAL';

    const type = DROP_TYPES[typeKey];
    state.drops.push({
        x: Math.random() * state.width,
        y: -20,
        ...type,
        id: typeKey
    });

    setTimeout(createDrop, Math.max(200, 1000 - (state.difficulty * 50)));
}

function update() {
    if (!state.running) return;

    // Player Interpolation
    player.x += (player.targetX - player.x) * 0.2;

    // Difficulty scaling
    state.difficulty += 0.0005;

    // Particles
    for (let i = state.particles.length - 1; i >= 0; i--) {
        const p = state.particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.02;
        if (p.life <= 0) state.particles.splice(i, 1);
    }

    // Drops
    for (let i = state.drops.length - 1; i >= 0; i--) {
        const d = state.drops[i];
        let speedMult = state.powerups.slowmo > 0 ? 0.3 : 1;
        d.y += d.speed * state.difficulty * speedMult;

        // Magnet logic
        if (state.powerups.magnet > 0 && d.type === 'good') {
            const dx = player.x - d.x;
            const dy = (player.y - 10) - d.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 250) {
                d.x += dx * 0.1;
                d.y += dy * 0.1;
            }
        }

        // Collision with Catcher
        if (d.y > player.y - 10 && d.y < player.y + 10 && Math.abs(d.x - player.x) < player.w / 2 + 5) {
            handleCollect(d);
            state.drops.splice(i, 1);
            continue;
        }

        // Hit City (Bottom)
        if (d.y > state.height - 60) {
            if (d.type === 'bad') {
                takeDamage(d.damage);
                spawnParticles(d.x, state.height - 50, d.color, 10);
            }
            state.drops.splice(i, 1);
        }
    }

    // Powerdown timers
    if (state.powerups.shield > 0) state.powerups.shield -= 0.016;
    if (state.powerups.slowmo > 0) state.powerups.slowmo -= 0.016;
    if (state.powerups.magnet > 0) state.powerups.magnet -= 0.016;

    if (state.health <= 0) gameOver();
}

function handleCollect(d) {
    if (d.type === 'good') {
        state.score += Math.floor(d.value * state.powerups.multiplier);
        state.rc += d.rc;
        state.combo++;
        playSound(440 + (state.combo * 20), 'sine', 0.1);
        spawnParticles(d.x, d.y, d.color, 5);

        if (d.power === 'magnet') state.powerups.magnet = 5;
        if (d.power === 'heal') state.health = Math.min(state.maxHealth, state.health + 10);
    } else {
        if (state.powerups.shield > 0) {
            playSound(200, 'square', 0.1);
        } else {
            takeDamage(d.damage);
            state.combo = 0;
            playSound(100, 'sawtooth', 0.2);
            if (d.power === 'freeze') state.powerups.slowmo = 3;
        }
        spawnParticles(d.x, d.y, d.color, 15);
    }
    updateHUD();
}

function takeDamage(amt) {
    state.health -= amt;
    updateHUD();
    document.body.style.backgroundColor = 'red';
    setTimeout(() => document.body.style.backgroundColor = '', 50);
}

function spawnParticles(x, y, color, count) {
    for (let i = 0; i < count; i++) {
        state.particles.push({
            x, y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            color,
            life: 1.0
        });
    }
}

// --- RENDER ---
function draw() {
    ctx.clearRect(0, 0, state.width, state.height);

    // Background Gradient (Simplified)
    let grad = ctx.createLinearGradient(0, 0, 0, state.height);
    grad.addColorStop(0, '#0f2027');
    grad.addColorStop(1, '#2c5364');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, state.width, state.height);

    // Draw City
    ctx.fillStyle = '#111';
    ctx.fillRect(0, state.height - 60, state.width, 60);
    // Draw Windows
    ctx.fillStyle = state.health < 30 ? '#500' : '#f1c40f';
    for (let i = 0; i < state.width; i += 40) {
        ctx.fillRect(i + 10, state.height - 45, 15, 20);
    }

    // Draw Player (Catcher)
    ctx.shadowBlur = 15;
    ctx.shadowColor = state.powerups.shield > 0 ? '#00d2ff' : 'transparent';
    ctx.fillStyle = state.powerups.shield > 0 ? '#00d2ff' : '#fff';
    ctx.beginPath();
    ctx.roundRect(player.x - player.w/2, player.y, player.w, player.h, 10);
    ctx.fill();
    ctx.shadowBlur = 0;

    // Draw Drops
    state.drops.forEach(d => {
        ctx.fillStyle = d.color;
        ctx.shadowBlur = 10;
        ctx.shadowColor = d.color;
        ctx.beginPath();
        ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
        ctx.fill();
    });
    ctx.shadowBlur = 0;

    // Draw Particles
    state.particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 3, 3);
    });
    ctx.globalAlpha = 1;

    // UI Feedback for Shield
    if (state.powerups.shield > 0) {
        ctx.strokeStyle = '#00d2ff';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(player.x, player.y + 10, player.w * 0.8, 0, Math.PI * 2);
        ctx.stroke();
    }

    if (state.running) {
        update();
        requestAnimationFrame(draw);
    }
}

// --- UI & SYSTEM ---
function updateHUD() {
    scoreEl.innerText = state.score;
    rcEl.innerText = state.rc;
    const hpPercent = (state.health / state.maxHealth) * 100;
    healthBar.style.width = hpPercent + '%';
    healthBar.style.background = hpPercent < 30 ? 'var(--danger)' : '#00ff00';
}

function startGame() {
    state.running = true;
    state.score = 0;
    state.health = state.maxHealth;
    state.drops = [];
    state.difficulty = 1;
    state.combo = 0;
    
    // Apply Shop Buffs
    state.powerups.shield = state.ownedItems.includes('shield_up') ? 5 : 0;
    if (state.ownedItems.includes('city_hp_1')) state.maxHealth = 150;

    document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    updateHUD();
    createDrop();
    draw();
}

function gameOver() {
    state.running = false;
    if (state.score > state.bestScore) {
        state.bestScore = state.score;
        localStorage.setItem('rrain_best', state.bestScore);
    }
    localStorage.setItem('rrain_rc', state.rc);
    
    document.getElementById('gameover-screen').classList.remove('hidden');
    document.getElementById('final-score').innerText = state.score;
    document.getElementById('earned-rc').innerText = Math.floor(state.score / 10);
    document.getElementById('best-score').innerText = state.bestScore;
}

function openShop() {
    document.getElementById('menu-screen').classList.add('hidden');
    document.getElementById('gameover-screen').classList.add('hidden');
    document.getElementById('shop-screen').classList.remove('hidden');
    renderShop();
}

function renderShop() {
    const container = document.getElementById('shop-items-container');
    document.getElementById('shop-rc').innerText = state.rc;
    container.innerHTML = '';

    SHOP_ITEMS.forEach(item => {
        const isOwned = state.ownedItems.includes(item.id);
        const div = document.createElement('div');
        div.className = `shop-item ${isOwned ? 'owned' : ''}`;
        div.innerHTML = `
            <strong>${item.name}</strong>
            <p>${item.desc}</p>
            <p class="price-tag">${isOwned ? 'OWNED' : item.price + ' RC'}</p>
            <button ${isOwned || state.rc < item.price ? 'disabled' : ''} onclick="buyItem('${item.id}', ${item.price})">
                ${isOwned ? 'ACTIVE' : 'BUY'}
            </button>
        `;
        container.appendChild(div);
    });
}

window.buyItem = (id, price) => {
    if (state.rc >= price) {
        state.rc -= price;
        state.ownedItems.push(id);
        localStorage.setItem('rrain_rc', state.rc);
        localStorage.setItem('rrain_items', JSON.stringify(state.ownedItems));
        renderShop();
        playSound(880, 'sine', 0.2);
    }
};

// --- LISTENERS ---
document.getElementById('start-btn').onclick = startGame;
document.getElementById('retry-btn').onclick = startGame;
document.getElementById('shop-btn').onclick = openShop;
document.getElementById('shop-btn-go').onclick = openShop;
document.getElementById('close-shop-btn').onclick = () => {
    document.getElementById('shop-screen').classList.add('hidden');
    document.getElementById('menu-screen').classList.remove('hidden');
};

// Load initial stats
document.getElementById('best-score').innerText = state.bestScore;
</script>
</body>
</html>